#!/bin/bash                                                                                                                                                                                                                                                                                                                                                                                                                                                                               
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          
if (($# < 5))                                                                                                                                                                                                                                                                                                                                                                                                                                                                             
then                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      
    echo "USAGE:"                                                                                                                                                                                                                                                                                                                                                                                                                                                                         
    echo "ARG1:      original executable path"
    echo "ARG2:      optimized executable path"
    echo "ARG3:      number of executions"
    echo "ARG4:      args of the programs (inside \" \", if more than one"
    echo "ARG5:      input file name"
    echo "ARG6(opt): output file name"
    exit 0                                                                                                                                                                                                                                                                                                                                                                                                                                                                                
fi                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          
TIME_EXE="/usr/bin/time -p"                                                                                                                                                                                                                                                                                                                                                                                                                                                               
ORIGINAL_EXE=$1                                                                                                                                                                                                                                                                                                                                                                                                                                                                           
OPTIMIZED_EXE=$2                                                                                                                                                                                                                                                                                                                                                                                                                                                                          
N=$3                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      
PARAMS=$4                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 
INPUT_FILE=$5
RESULTS_FOLDER="$PWD/results"                                                                                                                                                                                                                                                                                                                                                                                                                                                             
DEFAULT_RESULTS_FILENAME="$ORIGINAL_EXE-$OPTIMIZED_EXE-P$PARAMS-N$N.res"                                                                                                                                                                                                                                                                                                                                                                                                                  
if (($# < 6))                                                                                                                                                                                                                                                                                                                                                                                                                                                                             
then                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      
        RESULTS_FILE="$RESULTS_FOLDER/$DEFAULT_RESULTS_FILENAME"                                                                                                                                                                                                                                                                                                                                                                                                                          
else                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      
        RESULTS_FILE="$RESULTS_FOLDER/$6"                                                                                                                                                                                                                                                                                                                                                                                                                                                 
fi                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        

# Create results directory if it does not exist                                                                                                                                                                                                                                                                                                                                                                                                                                           
mkdir -p $RESULTS_FOLDER                                                                                                                                                                                                                                                                                                                                                                                                                                                                  
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          
# Check both executions match. Abort otherwise                                                                                                                                                                                                                                                                                                                                                                                                                                            
echo "Checking results of both versions."                                                                                                                                                                                                                                                                                                                                                                                                                                                 
$ORIGINAL_EXE $PARAMS < $INPUT_FILE > .tmp.golden                                                                                                                                                                                                                                                                                                                                                                                                                                                       
$OPTIMIZED_EXE $PARAMS < $INPUT_FILE > .tmp.optimized                                                                                                                                                                                                                                                                                                                                                                                                                                                   
if cmp --silent -- .tmp.golden .tmp.optimized; then                                                                                                                                                                                                                                                                                                                                                                                                                                       
    echo "BOTH OUTPUTS ARE EQUAL"                                                                                                                                                                                                                                                                                                                                                                                                                                                         
else                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      
    echo "BOTH OUTPUTS ARE *NOT* EQUAL"                                                                                                                                                                                                                                                                                                                                                                                                                                                   
    exit 0                                                                                                                                                                                                                                                                                                                                                                                                                                                                                
fi                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          
echo "N      = $N" > $RESULTS_FILE                                                                                                                                                                                                                                                                                                                                                                                                                                                        
echo "PARAMS = $PARAMS" >> $RESULTS_FILE                                                                                                                                                                                                                                                                                                                                                                                                                                                  
echo "INPUT  = $INPUT_FILE" >> $RESULTS_FILE
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          
# Original executions                                                                                                                                                                                                                                                                                                                                                                                                                                                                     
echo "==== Doing $N executions of the original program ===="                                                                                                                                                                                                                                                                                                                                                                                                                              
echo "==== Doing $N executions of the original program ====" >> $RESULTS_FILE                                                                                                                                                                                                                                                                                                                                                                                                             
for (( i = 1; i <= $N; i++ )); do                                                                                                                                                                                                                                                                                                                                                                                                                                                         
    ($TIME_EXE ./$ORIGINAL_EXE $PARAMS < $INPUT_FILE >/dev/null) 2>&1                                                                                                                                                                                                                                                                                                                                                                                                                                   
done | awk '                                                                                                                                                                                                                                                                                                                                                                                                                                                                              
    BEGIN {                                                                                                                                                                                                                                                                                                                                                                                                                                                                               
        real = 0                                                                                                                                                                                                                                                                                                                                                                                                                                                                          
        cpu = 0                                                                                                                                                                                                                                                                                                                                                                                                                                                                           
        real_max = 0                                                                                                                                                                                                                                                                                                                                                                                                                                                                      
        real_min = 9999999.0                                                                                                                                                                                                                                                                                                                                                                                                                                                              
        cpu_max = 0                                                                                                                                                                                                                                                                                                                                                                                                                                                                       
        cpu_min = 9999999.0                                                                                                                                                                                                                                                                                                                                                                                                                                                               
    }                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     
    /real/ {                                                                                                                                                                                                                                                                                                                                                                                                                                                                              
        real = real + $2;                                                                                                                                                                                                                                                                                                                                                                                                                                                                 
        if ($2 < real_min) real_min = $2;                                                                                                                                                                                                                                                                                                                                                                                                                                                 
        if ($2 > real_max) real_max = $2;                                                                                                                                                                                                                                                                                                                                                                                                                                                 
        nr++                                                                                                                                                                                                                                                                                                                                                                                                                                                                              
    }                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     
    /user/ {                                                                                                                                                                                                                                                                                                                                                                                                                                                                              
        cpu_tmp = $2;                                                                                                                                                                                                                                                                                                                                                                                                                                                                     
        cpu = cpu + $2;                                                                                                                                                                                                                                                                                                                                                                                                                                                                   
    }                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     
    /sys/  {                                                                                                                                                                                                                                                                                                                                                                                                                                                                              
        cpu_tmp = cpu_tmp + $2                                                                                                                                                                                                                                                                                                                                                                                                                                                            
        cpu = cpu + $2;                                                                                                                                                                                                                                                                                                                                                                                                                                                                   
        if (cpu_tmp < cpu_min) cpu_min = cpu_tmp;                                                                                                                                                                                                                                                                                                                                                                                                                                         
        if (cpu_tmp > cpu_max) cpu_max = cpu_tmp;                                                                                                                                                                                                                                                                                                                                                                                                                                         
        nu++                                                                                                                                                                                                                                                                                                                                                                                                                                                                              
    }                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     
    END {                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 
        if (nr>0) printf("real %f\n", real/nr);                                                                                                                                                                                                                                                                                                                                                                                                                                           
        printf("real_max %f\n", real_max);                                                                                                                                                                                                                                                                                                                                                                                                                                                
        printf("real_min %f\n", real_min);                                                                                                                                                                                                                                                                                                                                                                                                                                                
        if (nu>0) printf("cpu %f\n", cpu/nu);                                                                                                                                                                                                                                                                                                                                                                                                                                             
        printf("cpu_max  %f\n", cpu_max);                                                                                                                                                                                                                                                                                                                                                                                                                                                 
        printf("cpu_min  %f\n", cpu_min);                                                                                                                                                                                                                                                                                                                                                                                                                                                 
    }' >> $RESULTS_FILE                                                                                                                                                                                                                                                                                                                                                                                                                                                                   
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          
# Optimized executions                                                                                                                                                                                                                                                                                                                                                                                                                                                                    
echo "==== Doing $N executions of the optimized program ===="                                                                                                                                                                                                                                                                                                                                                                                                                             
echo "==== Doing $N executions of the optimized program ====" >> $RESULTS_FILE                                                                                                                                                                                                                                                                                                                                                                                                            
for (( i = 1; i <= $N; i++ )); do                                                                                                                                                                                                                                                                                                                                                                                                                                                         
    ($TIME_EXE ./$OPTIMIZED_EXE $PARAMS < $INPUT_FILE >/dev/null) 2>&1                                                                                                                                                                                                                                                                                                                                                                                                                                  
done | awk '                                                                                                                                                                                                                                                                                                                                                                                                                                                                              
    BEGIN {                                                                                                                                                                                                                                                                                                                                                                                                                                                                               
        real = 0                                                                                                                                                                                                                                                                                                                                                                                                                                                                          
        cpu = 0                                                                                                                                                                                                                                                                                                                                                                                                                                                                           
        real_max = 0                                                                                                                                                                                                                                                                                                                                                                                                                                                                      
        real_min = 9999999.0                                                                                                                                                                                                                                                                                                                                                                                                                                                              
        cpu_max = 0                                                                                                                                                                                                                                                                                                                                                                                                                                                                       
        cpu_min = 9999999.0                                                                                                                                                                                                                                                                                                                                             
    }                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     
    /real/ {                                                                                                                                                                                                                                                                                                                                                                                                                                                                              
        real = real + $2;                                                                                                                                                                                                                                                                                                                                                                                                                                                                 
        if ($2 < real_min) real_min = $2;                                                                                                                                                                                                                                                                                                                                                                                                                                                 
        if ($2 > real_max) real_max = $2;                                                                                                                                                                                                                                                                                                                                                                                                                                                 
        nr++                                                                                                                                                                                                                                                                                                                                                                                                                                                                              
    }                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     
    /user/ {                                                                                                                                                                                                                                                                                                                                                                                                                                                                              
        cpu_tmp = $2;                                                                                                                                                                                                                                                                                                                                                                                                                                                                     
        cpu = cpu + $2;                                                                                                                                                                                                                                                                                                                                                                                                                                                                   
    }                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     
    /sys/  {                                                                                                                                                                                                                                                                                                                                                                                                                                                                              
        cpu_tmp = cpu_tmp + $2                                                                                                                                                                                                                                                                                                                                                                                                                                                            
        cpu = cpu + $2;                                                                                                                                                                                                                                                                                                                                                                                                                                                                   
        if (cpu_tmp < cpu_min) cpu_min = cpu_tmp;                                                                                                                                                                                                                                                                                                                                                                                                                                         
        if (cpu_tmp > cpu_max) cpu_max = cpu_tmp;                                                                                                                                                                                                                                                                                                                                                                                                                                         
        nu++                                                                                                                                                                                                                                                                                                                                                                                                                                                                              
    }                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     
    END {                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 
        if (nr>0) printf("real %f\n", real/nr);                                                                                                                                                                                                                                                                                                                                                                                                                                           
        printf("real_max %f\n", real_max);                                                                                                                                                                                                                                                                                                                                                                                                                                                
        printf("real_min %f\n", real_min);                                                                                                                                                                                                                                                                                                                                                                                                                                                
        if (nu>0) printf("cpu %f\n", cpu/nu);                                                                                                                                                                                                                                                                                                                                                                                                                                             
        printf("cpu_max  %f\n", cpu_max);                                                                                                                                                                                                                                                                                                                                                                                                                                                 
        printf("cpu_min  %f\n", cpu_min);                                                                                                                                                                                                                                                                                                                                                                                                                                                 
    }' >> $RESULTS_FILE                                                                                                                                                                                                                                                                                                                                                                                                                                                                   
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          
echo "==== Speedups ====" >> $RESULTS_FILE                                                                                                                                                                                                                                                                                                                                                                                                                                                
awk '                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     
    BEGIN {                                                                                                                                                                                                                                                                                                                                                                                                                                                                               
        original_real = 0;                                                                                                                                                                                                                                                                                                                                                                                                                                                                
        optimized_real = 1;                                                                                                                                                                                                                                                                                                                                                                                                                                                               
        original_cpu = 0;                                                                                                                                                                                                                                                                                                                                                                                                                                                                 
        optimized_cpu = 1;                                                                                                                                                                                                                                                                                                                                                                                                                                                                
    }                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     
    /real / {if (original_real == 0) original_real = $2; else optimized_real = $2}                                                                                                                                                                                                                                                                                                                                                                                                        
    /cpu /  {if (original_cpu == 0) original_cpu  = $2; else optimized_cpu = $2}                                                                                                                                                                                                                                                                                                                                                                                                          
    END {                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 
        printf("Speedup real: %f\n", original_real/optimized_real);                                                                                                                                                                                                                                                                                                                                                                                                                       
        printf("Speedup cpu : %f\n", original_cpu/optimized_cpu);                                                                                                                                                                                                                                                                                                                                                                                                                         
    }' $RESULTS_FILE >> $RESULTS_FILE                                                                                                                                                                                                                                                                                                                                                                                                                                                     
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          
echo "Results file: $RESULTS_FILE"
